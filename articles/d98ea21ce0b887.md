---
title: "JSDOMを使ったIntegration Testが時代遅れかも知れないので調べてみた"
emoji: "🐕"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
publication_name: globis
---

**ネタ元の記事 "Why I Won’t Use JSDOM"**
https://www.epicweb.dev/why-i-won-t-use-jsdom


## ネタ元記事の主張

**メインの批判点：**
1. **JSDOMの根本的問題**: Node.jsで動作し、ブラウザのふりをするが、結果的にどちらでもない中途半端な存在
2. **技術的制限**:
   - 標準ではないイベントを生成し、環境間で一貫性がない
   - グローバルAPIを問題のある方法でパッチする
   - ブラウザのエクスポート条件を強制することで依存関係を不適切に解決

**テスト哲学の問題**:
「テスト環境が実際のコード実行環境に近いほど、テストの価値が高まる」という考えに基づき、JSDOMは実ブラウザ環境から離れすぎている

**推奨される代替案**:
- **Vitest Browser Mode**: 実際のブラウザでテストを直接実行
- Playwrightをブラウザプロバイダーとして使用可能
- より信頼性の高いコンポーネントテストを提供

**結論**: ポリフィルの時代から脱却し、ブラウザ向けコードを実際のブラウザでテストする「パラダイムシフト」を提唱

## 調べる前の仮説

JSDOM自体はまだ非推奨ではないが、Vitest Browser Mode や Playwright Component Test などの実ブラウザを用いたテストが普及したので、それぞれ使い分けることが重要。軽量高速が効果的なユニットテストなどではVitest + JSDOMで高速に。よりユーザー目線の統合テストは Vitest Browser Mode などを用いて実DOMでテストを行う。のが良いのではないだろうか？

まずは主張と実体を調べ、その課題を解決するツールが育っているのか、その課題感は目的に対して妥当なのか？を調べる必要がある。

※仮説を持つことで、成功でも失敗でも、確実に自分の学習を高めることが出来るため、調査前段階の手持ちの知識で当たりをつけておいています。


## 調査中の疑問と解決リスト（執筆中メモ）

- なぜフロントエンドテストにはJSDOMが用いられたのか？
  - E2Eと比較して軽量高速にDOMを模倣したテストを実現したかったから
- なぜ記事では「JSDOMを使わない」と主張しているのか？
  - JSDOMは、node.jsで実行され、ブラウザのふりをするが、結局どちらでも無いから

## JSDOMを推奨しない流れは、世の中的には受け入れられ始めているのか？

**結論**: 既に世の中的にある動きで、フロントエンド開発の最前線にいる開発者たちでは当たり前になりつつある

### 市場データと技術トレンド
- **コンポーネントテスト領域での変化**: Playwright Component TestingやVitest Browser Modeなど、JSDOMの代替となる実ブラウザベースのコンポーネントテストツールが相次いで登場
- **InfoQの報道**: ["Vitest Introduces Browser Mode as Alternative to JSDOM"](https://www.infoq.com/news/2025/06/vitest-browser-mode-jsdom/)として大手技術メディアが取り上げ
- **Epic Web Devの主張**: ["ブラウザ向けUIコンポーネントは実ブラウザでテストすべき。ツールが整った今、それが可能になった"](https://www.epicweb.dev/why-i-won-t-use-jsdom)

### 推進派の反応
- **Vitest開発チーム**: [JSDOM代替としてのBrowser Mode開発を積極推進](https://vitest.dev/guide/browser/)、2025年6月にInfoQでも報道
- **Epic Web Dev**: ["JSDOMは必要なトレードオフだったが、今はより良いツールがある"](https://www.epicweb.dev/why-i-won-t-use-jsdom)
- **開発者コミュニティ**: Testing LibraryのGitHubでも["Render in browser instead of JSDom"](https://github.com/testing-library/dom-testing-library/issues/544)という要望が議論されている

### より慎重な見解・使い分けを主張する意見
- **Kent C. Dodds（React Testing Library作者）**: ["Testing LibraryはJSDOMを直接使用せず、利用可能なDOM環境を使う。パフォーマンス問題はJSDOM（JavaScript実装）が原因で、Testing Libraryのクエリが原因ではない。実ブラウザ（Playwrightなど）でのテスト実行を推奨"](https://x.com/kentcdodds/status/1767305104011444542)（2024年3月）
- **週14百万回のダウンロード**: npm統計によると、JSDOMは最も実績があり信頼性の高い非ブラウザDOMモジュール
- **適切な使い分けの重要性**:
  - **軽量ユニットテスト**: JSDOMは実ブラウザ起動のオーバーヘッドなしで高速
  - **包括的なブラウザAPI**: 複雑なDOM操作、CSS、レイアウトテストに対応
  - **90-99%のケースで十分**: Jest + JSDOMは一般的なテストニーズの大部分をカバー
- **パフォーマンス最適化**: 非UIテストでJSDOMを無効化することで[テスト速度を2倍向上](https://kevinsimper.medium.com/how-to-disable-jsdom-in-jest-make-jest-run-twice-as-fast-a01193f23405)させることが可能

### 具体的な移行事例
- **SingleStore**: ["Our Journey From JSDOM and React Testing Library Toward Cypress Component Testing"](https://www.singlestore.com/blog/our-journey-from-jsdom/)として移行事例を公開
- **Epic Web Dev**: [実ブラウザテストへの移行を推進するワークショップ](https://www.epicweb.dev/workshops/react-component-testing-with-vitest)を開催
- **多数の開発者**: "JSDOM took +9 seconds to parse, used 1G of heap memory"などパフォーマンス問題を報告

### 技術的背景の変化
- **CI/CD環境の改善**: ヘッドレスブラウザの起動コストが大幅削減
- **ツールの成熟**: Playwright/Puppeteerで実ブラウザテストが簡単に
- **デバッグ体験**: 視覚的確認や実際のブラウザデベロッパーツールが使用可能

**参考記事**:
- [Vitest Introduces Browser Mode as Alternative to JSDOM - InfoQ](https://www.infoq.com/news/2025/06/vitest-browser-mode-jsdom/)
- [Our Journey From JSDOM and React Testing Library Toward Cypress Component Testing - SingleStore](https://www.singlestore.com/blog/our-journey-from-jsdom/)
- [Playwright Component Testing: A Modern Alternative to Old Tools - TestOMat](https://testomat.io/blog/playwright-component-testing-as-modern-alternative-to-traditional-tools/)


## CI実行時間への影響調査：「実ブラウザテストは本当に遅いのか？」

**結論**: 従来の「実ブラウザテストはCI時間が長くなる」という認識は**既に古い**。現在はJSDOMの方がボトルネックになるケースが多い。

### CI実行時間の実測比較

**JSDOMの現実的な遅さ**:
- DOM操作: **JSDOM 15秒 vs LinkedOM 2.6ms**（600倍の差）- [LinkeDOM: A JSDOM Alternative](https://webreflection.medium.com/linkedom-a-jsdom-alternative-53dd8f699311)
- コンテンツ抽出: **JSDOM平均517ms vs Cheerio平均300ms** - [jsdom vs. Cheerio: Which Is Best for You?](https://www.zenrows.com/blog/jsdom-vs-cheerio)
- Material-UI大規模プロジェクト: **v23.1.0で3分30秒→v23.2.0で7分30秒（×2倍悪化）** - [JSDOM Issue #3659](https://github.com/jsdom/jsdom/issues/3659)
- 12MBドキュメント解析: **9秒解析、1GBメモリ使用** - [LinkeDOM: A JSDOM Alternative](https://webreflection.medium.com/linkedom-a-jsdom-alternative-53dd8f699311)

**Modern Browser Modeの実績**:
- **Vitest**: 1338テスト 460秒 vs Jest 865秒（**47%高速化**） - [Vitest runs Unit Tests 50% Faster](https://sdust.dev/posts/2023-10-05_vitest-runs-unit-tests-faster)
- **Playwright**: WebSocket接続により従来Seleniumより大幅高速化 - [Playwright vs Cypress: A Comparison](https://www.browserstack.com/guide/playwright-vs-cypress)
- **並列実行**: 複数Browser Contextで初期化コストを分散

### 実際の移行事例での時間変化

**SingleStore社の報告** - [Our Journey From JSDOM and React Testing Library Toward Cypress Component Testing](https://www.singlestore.com/blog/our-journey-from-jsdom/):
- **移行前**: JSDOMで「slowness became a problem」
- **移行後**: Cypress Component Testing採用で速度問題解決
- **構成変化**: 72 RTLテストファイル→2ファイル、新規70 CCTファイル作成
- **副次効果**: フレーキネス問題も同時解決

### 2024-2025年の技術状況

**JSDOMの限界** - [jsdom vs happy-dom: Navigating the Nuances of JavaScript Testing](https://blog.seancoughlin.me/jsdom-vs-happy-dom-navigating-the-nuances-of-javascript-testing):
- Happy DOM比で**2-3倍遅い**（同一処理での比較）
- 包括的ブラウザエミュレーションによる**パフォーマンスコスト**が顕著
- 大規模テストスイートで**指数的な速度劣化**

**Browser Mode（Vitest/Playwright）の優位性** - [Vitest Introduces Browser Mode as Alternative to JSDOM](https://www.infoq.com/news/2025/06/vitest-browser-mode-jsdom/):
- **初期化コスト**: あるが並列実行でカバー
- **実行効率**: 実ブラウザの最適化されたエンジンを活用
- **CI環境**: ヘッドレスブラウザ起動コストが大幅削減済み

### 適切な使い分け指針

**JSDOMが有効**: 軽量ユニットテスト、基本的DOM操作のみ

**Browser Mode推奨**: CSS/レイアウト、ブラウザAPI、統合テスト、**CI時間短縮重視**の大規模プロジェクト
