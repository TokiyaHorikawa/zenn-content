---
title: "ESLintでガッツリ縛ったプロジェクトへの段階的Biome導入の記録（前篇）"
emoji: "🐿️"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [typescript, eslint, biome]
published: false
publication_name: globis
---

## 課題

#### 😰 待ち時間が長いと、集中の寸断が発生して効率を落とす

- ESLintをローカルで実行すると1分30秒くらい掛かっていた
- エディタのESLint拡張が重たくなる時がある
- pre-commitが長い

CIは...早いに越したことは無いがテスト系がもっと長いので一旦課題感は小さい

## 目指す状態

#### ESLintとBiomeの併用で良いとこ取り

- 基本のルールはBiomeで縛る（1秒未満を目指す）
- 独自ルールやLibrary推奨のルールはESLintで縛る（5秒以内を目指す）


## 完全置き換えから併用に至るまでの思考過程


### 💡 ESLintをBiomeに置き換えれば速くなるかもしれない！

確かに早い！
0.3秒くらいで recommended のルールなら実行できた(800件くらいエラーを出しつつも)

#### 問題:
  - Biomeは、ESLintのRulesを完全互換できない
  - 独自ルールが作れない
  - testing-libraryやvitestなど、Library推奨の npm package として公開されているrulesが無い

↓
完全互換は多くのルールで縛ったプロジェクトには向かない。。。
じゃあ、Biomeは諦めるか？
↓
いや、Biomeに寄せつつ、ESLintで細かいルールを補えばいいのでは？

### 💡 ESLintを極力削りつつ、Biomeと併用することで「速さ」と「縛り」を両立させられるかもしらない！

概ね併用の考え方で良さそう。

#### 問題:

- ESLintの何を削れば良い？
- 大量のBiomeエラーがでてしまって差分がデカい
- Formatter は Prettier と併用させる？

うん、やることは多そうだ。
🥰 **小さく段階的に導入していこう！**

## Biomeの導入


[Biome公式 Getting Started](https://biomejs.dev/guides/getting-started/)と[Biome公式 Migrate from ESLint & Prettier](https://biomejs.dev/guides/migrate-eslint-prettier/)を参考にしていく。

### 1. Biomeはrootに1つだけ導入する（monorepoの話）

最初にyarn workspace で、それぞれのworkspaceごとにbiomeを導入しようとした。背景としては、ESLintはworkspaceごとに `.eslintrc.js` で設定を個別で書いていたからそれに合わせた形だった。

```bash
# ⭕️ rootにだけ導入で良さそう
yarn add --dev --exact @biomejs/biome

# ❌️ 当初はworkspaceごとに導入しようとしていた
yarn workspace packageA add --dev --exact @biomejs/biome
yarn workspace packageB add --dev --exact @biomejs/biome
yarn workspace packageC add --dev --exact @biomejs/biome
```

#### Q. workspaceごとにルールを変えたかったら？

A. workspaceごとに `biome.json` を作成する

- biomeは実行された場所を起点に `biome.json` を探す
- 実行階層に `biome.json` が有ればその設定を見てくれる
- 無ければ上に遡ってrootの `biome.json` を見に行く

※ 噂によると VSCode などの拡張では root だけを読みに行くらしい？また workspace 拡張で開いた場合はどうなるのだろう？

[Biome公式 Big Projects](https://biomejs.dev/guides/big-projects/)
[Biome の導入と設定方法まとめ - 設定と振る舞い](https://zenn.dev/akineko/articles/d967d5dcada598#%E8%A8%AD%E5%AE%9A%E3%81%A8%E6%8C%AF%E3%82%8B%E8%88%9E%E3%81%84)

#### Q. ルールを継承したければ？

A. workspace の `biome.json` にrootの `biome.json` を `extends` する

```json
{
  "extends": ["../biome.json"]
}
```

### 2. migrateコマンドで導入

メインのパッケージのルールを元にmigrateするために、特定配下で `biome migrate` コマンドを実行する。

```bash
cd root/packages/packageA # 任意の.eslintrc.jsがある階層で
yarn biome migrate eslint --write
yarn biome migrate prettier --write
```

`biome.json`が作成されるが、初動を楽にしてくれるくらいの気持ちでどんどん編集して落とし所を探そう。

### 3. 小さく段階的に導入するために、差分の出るルールをoffにする

段階的に導入するため、まずほ基本ルールは全て off で導入する。
ESLintと完全に同じ部分はそのまま ON で recommended を受け入れる。

```json
{
  "$schema": "./node_modules/@biomejs/biome/configuration_schema.json",
  "vcs": {
    "enabled": false,
    "clientKind": "git",
    "useIgnoreFile": true // おそらく root の .gitignore しか見れていない
  },
  "files": {
    "ignoreUnknown": false,
    // NOTE: "packages/**/*.[ts,tsx,js,jsx,json]" の様な指定はできないらしい。。。
    "include": [
      "packages/**/*.ts",
      "packages/**/*.tsx",
      "packages/**/*.js",
      "packages/**/*.jsx",
      "packages/**/*.json"
    ],
    "ignore": [
      "**/node_modules/**",
    ]
  },
  "formatter": {
    "enabled": false, // prettierを取り除くまで OFF
  },
  "organizeImports": {
    "enabled": false // 差分が多すぎるので一旦 OFF
  },
  "linter": {
    "enabled": true,
    "rules": {
      "recommended": true, // 推奨ルールは ON にしていきたい
      // 省略するが、一旦 recommended の差分の多いルールは OFF にして導入だけ果たす
      // 段階的に1ルールずつPRを作成して適用する
      "style": {
        "useImportType": "error", // これだけ ESLint とほぼ互換があったので ON にしてみた例
        "useNumberNamespace": "off",
      },
    }
  },
  "javascript": {
    "jsxRuntime": "reactClassic" // Reactのimportを一旦許す v18移行では必要無いが差分が大きかった
  }
}

```

### 4. CIで動く様にする

ESLintが動いているCIに Biome を追加するだけでOKなので、特筆することはなかった。
GitHub Actions や CircleCI などに用意してある script を動かせば良い

#### 余談: workspaceトップのscriptsイメージ
workspaceごとにeslintを回していれば、biome + 並列でeslintを回すのがおすすめかも

```json:root/package.json
"scripts": {
  "lint": "yarn biome check && yarn eslint-parallel",
  "lint:ci": "yarn biome ci && yarn eslint-parallel",
  "eslint-parallel": "yarn workspaces foreach -Api --exclude $(basename $PWD) run lint",
}
```

また、biomeは `lint`, `check`, `ci`, `format` 等があるため、用途によって使い分ける。
(`biome check`はlint, format, import sortingを実行する)
[Biome CLI公式コマンド一覧](https://biomejs.dev/ja/reference/cli/)

#### 余談: Localではエラー0なのに、CIでだけエラーが大量に出る！！？

CI実行時に生成しているファイルのignoreを忘れていただけだった。
Localには無いファイルだったので、てっきり biome.json が CI上でだけ読み込まれていないかと思って慌ててしまった。

### 5. pre-commitでESLintとBiomeを併用する

## ESLintの実行時間の長いルールを削る

## 互換性のあるBiomeのルールを適用する

## ESLintのルールを本当に必要なものだけに減らす
