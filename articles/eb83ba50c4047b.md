---
title: "Railsã§parent.children = childrenã§å­ãŒDBã«ä¿å­˜ã•ã‚ŒãŸã®ã«é©šã„ã¦èª¿ã¹ãŸ"
emoji: "ğŸ’"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [ruby, rubyonrails, activerecord]
published: false
---

### å‰ææƒ…å ±

```Gemfile
ruby '3.3.6'
gem 'rails', '~> 7.2'
```

ç­†è€…ã¯ React.js ã¨ TypeScript ã‚’ä¸»æˆ¦å ´ã¨ã—ã¦ã„ãŸãŒ
Rails ã‚’æ›¸ãæ©Ÿä¼šãŒå¢—ãˆã¦ã€ã¡ã‚‡ã£ã¨é©šãã¾ã—ãŸã¨ã„ã†è¨˜äº‹ã§ã™ã€‚

# ã€å•é¡Œæèµ·ã€‘ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä»£å…¥ã ã‘ã§ DB ã«ä¿å­˜ã•ã‚Œã‚‹ã®ã¯ãªãœï¼Ÿ

`parent.children = children`
ã§å­ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒ DB ã«ä¿å­˜ã•ã‚Œã‚‹ã®ãŒã€ã€Œé©šãã€ã ã£ãŸã€‚

`parent.save`ã§ autosave ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã¾ã§ã¯ãƒ¡ãƒ¢ãƒªä¸Šã®ã¿ã®ä»£å…¥ã ã¨æ€ã£ã¦ã„ãŸ

### å‚è€ƒã®ã‚³ãƒ¼ãƒ‰

```rb
# Read Only APIã®å‡¦ç†ã®ä¸­ã§

class ParentAPI
  def call
    parent = Parent.find(id)
    children = [
      Child.build(name: 'å­1'),
      Child.build(name: 'å­2'),
    ]
    # é©šããƒã‚¤ãƒ³ãƒˆ: ã“ã“ã§å­ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
    parent.children = children

    # æœ¬æ¥ã¯ã“ã“ã§autosaveã§è¦ªå­ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒä¿å­˜ã•ã‚Œã‚‹ã¨æ€ã£ã¦ã„ãŸ
    parent.save!
  end
end
```

ãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ¡ãƒ¼ã‚¸

```rb
class Parent < ApplicationRecord
  has_many :children
end

class Child < ApplicationRecord
  belongs_to :parent
end
```

## ãƒ¡ãƒ¢ãƒªä¸Šã§ç•™ã‚ãŸã„ãªã‚‰

ã©ã†ã—ã¦ã‚‚ä¿å­˜ã¯ parent ã® autosave ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ä¸€ç·’ã«ä¿å­˜ã—ãŸã„ï¼ï¼
ã¨ã„ã†å ´åˆã¯ã€

`parent.children.build` ã§ build ã™ã‚Œã°ã€ãƒ¡ãƒ¢ãƒªä¸Šã®ã¿ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã¦æ­¢ã‚ã‚‰ã‚Œã‚‹ã€‚
äº‹å‰ã« hash ã®å½¢ã§ä½œã£ã¦ãŠã‘ã°ã€ã¾ã¨ã‚ã¦ build ã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹

```diff rb
# Read Only APIã®å‡¦ç†ã®ä¸­ã§

class ParentAPI
  def call
    parent = Parent.find(id)
-    children = [
-      Child.build(name: 'å­1'),
-      Child.build(name: 'å­2'),
-    ]
+    children_array = [
+      { name: 'å­1' },
+      { name: 'å­2' },
+    ]

-    parent.children = children
+    parent.children.build(children_array)

    parent.save!
  end
end
```

save!ã®å‰ã§ binding.pry ã—ãŸçŠ¶æ…‹ã®ã‚¤ãƒ¡ãƒ¼ã‚¸
ã¾ã ä¿å­˜ã•ã‚Œã¦ã„ãªã„äº‹ãŒã‚ã‹ã‚‹

```bash
From: /hoge/fuga/parent_api.rb:45 ParentAPI#call:

    40: def call
    41:   children_array = [
    42:     { name: 'å­1' },
    43:     { name: 'å­2' },
    44:   ]
 => 45:   parent.children.build(children_array)
    46:   binding.pry
    47:   parent.save!
    48: end

[1] pry(#<ParentAPI>)> parent.children
=> [#<Child:0x0000ffff7cacd218
  id: nil,
  name: "å­1",
  parent_id: 1,
  created_at: nil,
  updated_at: nil>,
 #<Child:0x0000ffff7cacd0d8
  id: nil,
  name: "å­2",
  parent_id: 1,
  created_at: nil,
  updated_at: nil>]
[2] pry(#<ParentAPI>)> parent.children.first.new_record?
=> true
```

ã¡ãªã¿ã«ã€ã“ã‚Œã‚‰ã¯ parent.save ã®å‰ã« DB ã«ä¿å­˜ã•ã‚Œã¦ã—ã¾ã†

```rb
parent.children = children

parent.children << [child1, child2]
```

è©³ã—ãã¯ä¸‹è¨˜ã‚’è¦‹ãŸã‚‰è§£æ±ºã™ã‚‹ã®ã§ã‚¹ãƒ«ãƒ¼
[[åˆå¿ƒè€…å‘ã‘] Rails ã§é–¢é€£ã™ã‚‹ãƒ‡ãƒ¼ã‚¿(è¦ªå­é–¢ä¿‚)ã‚’ä¿å­˜ã™ã‚‹æ–¹æ³•ã‚ã‚Œã“ã‚Œ](https://qiita.com/jnchito/items/7f41ff3df900909952db)

# èª¿æŸ»çµæœ

## Q. ActiveRecord ã¯ãªãœä»£å…¥ã ã‘ã§ä¿å­˜ã™ã‚‹ä»•æ§˜ã«ã—ã¦ã„ã‚‹ã®ã‹ï¼Ÿ

WIP
DB ã®æ•´åˆæ€§ã‚’ä¿ã¤ãŸã‚ã€ã€ã€ã®æ§˜ãªè©±ã¯ã‚ã£ãŸãŒ
å…¬å¼ã®è¦‹è§£ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ããªã‹ã£ãŸã€‚

## Q. parent.children = children ã§è¿½åŠ ã€æ›´æ–°ã©ã“ã‚ã‹å‰Šé™¤ã‚‚ã•ã‚Œã‚‹ã®ã§ã¯ï¼Ÿ

è¿½åŠ ã®æŒ™å‹•ã¯è¨€ã‚ãšã‚‚ãŒãªãªã®ã§çœç•¥
â€» save ã‚’ã—ãªãã¦ã‚‚ DB ã®æ›¸ãè¾¼ã¿ãŒè¡Œã‚ã‚Œã¦ã„ã‚‹ã¨ã„ã†è©±

ğŸ”¥ æ­£ç›´ã€ã“ã®æŒ™å‹•ã‚’è¦‹ã¦æ°—è»½ã« association ä½¿ã£ã¦ä»£å…¥ã™ã‚‹ã®ã¯æ€–ã„ã¨æ€ã£ãŸã€‚

ğŸ”¥**è¿½åŠ ã—ãŸã‘ã‚Œã° `<<` ã‚’ä½¿ãŠã†ã¨æ€ã†ã€‚**
æ›´æ–°ãŒæœ‰ã‚Œã°é‡è¤‡ã§ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã—ã€å‰Šé™¤ã¯ã•ã‚Œã‚‹ã“ã¨ã¯ç„¡ã„ã€‚

### å‰Šé™¤ã®æŒ™å‹•

```rb
class ParentAPI
  def call
    parent = Parent.find(id)
    parent.children.create(name: 'äº‹å‰ãƒ‡ãƒ¼ã‚¿')

    children = [
      Child.build(name: 'å­1'),
      Child.build(name: 'å­2'),
    ]
    parent.children = children
    # ===> ã“ã®æ™‚ç‚¹ã§ ã€Œäº‹å‰ãƒ‡ãƒ¼ã‚¿1ã€ ã¯å‰Šé™¤ã•ã‚Œã‚‹ï¼ˆDBãƒ¬ãƒ™ãƒ«ï¼‰
  end
end
```

### æ›´æ–°ã®æŒ™å‹•

```rb
class ParentAPI
  def call
    parent = Parent.find(id)
    pre_child = parent.children.create(name: 'äº‹å‰ãƒ‡ãƒ¼ã‚¿')
    pre_child[:name] = 'æ›´æ–°ã•ã‚ŒãŸäº‹å‰ãƒ‡ãƒ¼ã‚¿'

    children = [
      pre_child,
      Child.build(name: 'å­2'),
    ]
    parent.children = children
    # ===> ã“ã®æ™‚ç‚¹ã§ ã€Œäº‹å‰ãƒ‡ãƒ¼ã‚¿1ã€ ã¯æ›´æ–°ã•ã‚Œã‚‹ï¼ˆDBãƒ¬ãƒ™ãƒ«ï¼‰
    # ã¾ãŸã€ã€Œå­2ã€ ãŒè¿½åŠ ã•ã‚Œã‚‹ï¼ˆä¿å­˜æ¸ˆã¿ï¼‰
  end
end
```

ã¡ãªã¿ã«ã€ã€ã€
ã“ã‚“ãªæ„Ÿã˜ã«ã™ã‚‹ã¨é‡è¤‡ã‚¨ãƒ©ãƒ¼ã§ä¿å­˜ã§ããªã„

```rb
class ParentAPI
  def call
    parent = Parent.find(id)
    pre_child = parent.children.create(name: 'äº‹å‰ãƒ‡ãƒ¼ã‚¿')

    children = [
      Child.build(name: 'å­1', id: pre_child.id),
      Child.build(name: 'å­2'),
    ]
    parent.children = children
    # ===> ã“ã®æ™‚ç‚¹ã§ åŒã˜ id child ãŒã‚ã‚‹çŠ¶æ…‹ã«ãªã‚‹ï¼ˆã€Œäº‹å‰ãƒ‡ãƒ¼ã‚¿ã€ã¨æœªä¿å­˜ã®ã€Œå­1ã€ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼‰
    # ã¾ãŸã€ã€Œå­2ã€ ãŒè¿½åŠ ã•ã‚Œã‚‹ï¼ˆä¿å­˜æ¸ˆã¿ï¼‰

    parent.save!
    # ===> é‡è¤‡ã‚¨ãƒ©ãƒ¼ã§ä¿å­˜ã§ããªã„ï¼ˆActiveRecord::RecordNotUniqueï¼‰
  end
end
```

## Q. build æ™‚ã« Association ã‚’æ˜ç¤ºæŒ‡å®šã™ã‚‹ã¨æŒ™å‹•ãŒå¤‰ã‚ã‚‹ï¼Ÿ

- ğŸ”¥`parent.children = children`ã‚’ã—ãªãã¦ã‚‚æ—¢ã«ç´ä»˜ã„ã¦ã„ã‚‹
  - ã“ã®æ™‚ç‚¹ã§ã¯ã€æœªä¿å­˜ã§ã‚ã‚‹
  - parent.save! ã§ä¿å­˜ã•ã‚Œã‚‹
  - ä»£å…¥ã—ã¦ã„ãªã„ãŸã‚ã€å‰Šé™¤ãŒå®Ÿè¡Œã•ã‚Œãªã„
- å¿…è¦ç„¡ã„ãŒã€ä»£å…¥ï¼ˆ`parent.children = children`ï¼‰ã‚’ã™ã‚‹ã¨
  - ğŸ”¥ ã“ã®æ™‚ç‚¹ã§å‰Šé™¤ãŒå®Ÿè¡Œã•ã‚Œã‚‹ï¼ˆDB ãƒ¬ãƒ™ãƒ«ã®å‰Šé™¤ï¼‰
  - ã“ã®æ™‚ç‚¹ã§ã¯ã€è¿½åŠ åˆ†ã¯æœªä¿å­˜ã§ã‚ã‚‹
  - parent.save! ã§ä¿å­˜ã•ã‚Œã‚‹

ã“ã¡ã‚‰ã‚‚æš—é»™çš„ãªæŒ™å‹•ãŒå¤§ãã„ã¨æ€ã†ã€‚
`=`ã‚„`<<` ã‚‚ç„¡ã„ã®ã§ã€build æ™‚ã« association ã‚’å…¥ã‚Œã¦ã„ãŸã‹ã§ parent.save!ã—ãŸæ™‚ã«ã€ä½•ã‹ã—ã‚‰ã‚“ã‚„ã¤ãŒä¿å­˜ã•ã‚Œã¦ã‚‹ã€ã€ã€ã¨ã‹ã«ãªã‚Šãã†ï¼Ÿ

```rb
class ParentAPI
  def call
    parent = Parent.find(id)
    parent.children.create(name: 'äº‹å‰ãƒ‡ãƒ¼ã‚¿')

    children = [
      Child.build(name: 'å­1', parent:), # ğŸ’ association ã‚’æ˜ç¤ºæŒ‡å®š
      Child.build(name: 'å­2', parent:), # ğŸ’ association ã‚’æ˜ç¤ºæŒ‡å®š
    ]
    # ===> ã“ã®æ™‚ç‚¹ã§æœªä¿å­˜ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒæ—¢ã«ç´ä»˜ã„ã¦ã„ã‚‹
    # parent.children => [äº‹å‰ãƒ‡ãƒ¼ã‚¿, å­1ï¼ˆæœªä¿å­˜ï¼‰, å­2ï¼ˆæœªä¿å­˜ï¼‰]

    # ğŸ”¥æ—¢ã«ç´ä»˜ã„ã¦ã„ã‚‹ã®ã§ä»£å…¥ã‚‚ã„ã‚‰ãªã„
    # parent.children = children
    # ===> ä»£å…¥ã™ã‚‹ã¨å·®åˆ†ã®ã€Œäº‹å‰ãƒ‡ãƒ¼ã‚¿ã€ã¯å‰Šé™¤ã•ã‚Œã‚‹ï¼ˆè¿½åŠ ã¯æœªä¿å­˜ï¼‰
    # parent.children => [å­1ï¼ˆæœªä¿å­˜ï¼‰, å­2ï¼ˆæœªä¿å­˜ï¼‰]

    parent.save!
    # ===> è¿½åŠ ã•ã‚Œã¦ã€äº‹å‰ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã•ã‚Œã¦ã„ãªã„
    # parent.children => [äº‹å‰ãƒ‡ãƒ¼ã‚¿, å­1, å­2]
  end
end
```

## Q. parent ãŒæ—¢ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹ã§æŒ™å‹•ãŒå¤‰ã‚ã‚‹ã®ã§ã¯ï¼Ÿ

## Q. parent.save æ™‚ã®æŒ™å‹•ã‚‚ has_many autosave: nil, true, false ã§å¤‰ã‚ã‚‹ã®ã§ã¯ï¼Ÿ

has_many ã®é–¢é€£ã§ autosave ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æœ‰ç„¡ã‚„è¨­å®šå€¤ã«å¿œã˜ã¦ã€æ–°è¦ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ä¿å­˜ã€æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã®æ›´æ–°ã€æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã®å‰Šé™¤ã®æŒ™å‹•ãŒç•°ãªã‚‹ãã†ã§ã™ã€‚
`parent.save!`ã§ã¾ã¨ã‚ã¦ä¿å­˜ã•ã‚Œã¦ã„ãŸã®ã¯ã€ã“ã®è¨­å®šã®ãŠã‹ã’

```rb
class Parent < ApplicationRecord
  has_many :children, autosave: true # ã¾ãŸã¯ false
end
```

| autosave è¨­å®š | æ–°ã—ã„é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰ | æ—¢å­˜ã®é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰ã®æ›´æ–° | æ—¢å­˜ã®é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰ã®å‰Šé™¤ |
| ------------- | ------------------ | ------------------------ | ------------------------ |
| è¨­å®šãªã—      | â­•ï¸                | âŒ                       | âŒ                       |
| true          | â­•ï¸                | â­•ï¸                      | â­•ï¸                      |
| false         | âŒ                 | âŒ                       | âŒ                       |

â­•ï¸: ä¿å­˜ã•ã‚Œã‚‹
âŒ: ä¿å­˜ã•ã‚Œãªã„

- **autosave: è¨­å®šãªã—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šï¼‰**
  - æ–°ã—ã„é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰: ä¿å­˜ã•ã‚Œã¾ã™ã€‚
  - æ—¢å­˜ã®é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰ã®æ›´æ–°: ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚
  - æ—¢å­˜ã®é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰ã®å‰Šé™¤: ä¿å­˜ã•ã‚Œã¾ã›ã‚“ï¼ˆå‰Šé™¤ã®æ“ä½œã‚‚é©ç”¨ã•ã‚Œã¾ã›ã‚“ï¼‰ã€‚
- **autosave: true**
  - æ–°ã—ã„é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰: ä¿å­˜ã•ã‚Œã¾ã™ã€‚
  - æ—¢å­˜ã®é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰ã®æ›´æ–°: ä¿å­˜ã•ã‚Œã¾ã™ã€‚
  - æ—¢å­˜ã®é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰ã®å‰Šé™¤: ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆå‰Šé™¤ã®æ“ä½œã‚‚é©ç”¨ã•ã‚Œã¾ã™ï¼‰ã€‚
- **autosave: false**
  - æ–°ã—ã„é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰: ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚
  - æ—¢å­˜ã®é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰ã®æ›´æ–°: ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚
  - æ—¢å­˜ã®é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰ã®å‰Šé™¤: ä¿å­˜ã•ã‚Œã¾ã›ã‚“ï¼ˆå‰Šé™¤ã®æ“ä½œã‚‚é©ç”¨ã•ã‚Œã¾ã›ã‚“ï¼‰ã€‚

https://api.rubyonrails.org/classes/ActiveRecord/AutosaveAssociation.html
https://mogulla3.tech/articles/2021-02-07-01/

### è„±ç·š: autosave è¨­å®šãªã—ã¯æ—¢å­˜ã®é–¢é€£ã‚³ãƒ¼ãƒ‰ã®æ›´æ–°ã•ã‚Œãªã„ã£ã¦æœ¬å½“ï¼ï¼Ÿ

ç­†è€…ãŒã€Œå˜˜ã ï¼ãã‚“ãªã®ä¿¡ã˜ãªã„ãï¼ã€ã¨å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ç–‘ã„ã‚’æŒã£ãŸã®ã§ã€å®Ÿéš›ã«è©¦ã—ã¦ã¿ãŸã€‚
å¤§äººã—ãæ•—åŒ—ã—ãŸã€‚

```rb
# Read Only APIã®å‡¦ç†ã®ä¸­ã§

class ParentAPI
  def call
    parent = Parent.find(id)

    # ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã™ã‚‹
    child1 = Child.create(name: 'å­1', parent:)
    child2 = Child.create(name: 'å­2', parent:)

    # ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¸Šã§ã¯ã€nameãŒæ›´æ–°ã•ã‚Œã‚‹ã®ã‚’ç¢ºèª
    # ex: child1.name = "æ›´æ–°ã•ã‚ŒãŸå­1"
    parent.children.each do |child|
      child.name = "æ›´æ–°ã•ã‚ŒãŸ#{child.name}"
    end

    # childã®nameã¯æ›´æ–°ã•ã‚Œã¦ã„ãªã„ï¼ï¼
    # ex: child1.name = "å­1"
    parent.save!
  end
end
```
