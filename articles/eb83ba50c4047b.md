---
title: "Railsã® parent.children = children ã§ parent.save! å‰ã«å­ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒä½œæˆã•ã‚ŒãŸè©±"
emoji: "ğŸ’"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [ruby, rubyonrails, activerecord]
published: false
---

### å‰ææƒ…å ±

```Gemfile
ruby '3.3.6'
gem 'rails', '~> 7.2'
```

[ãƒ¡ãƒ¢ã¨ã—ã¦æ›¸ã„ã¦ã„ãŸ Zenn Scrap](https://zenn.dev/tokiya_horikawa/scraps/4aa31992b31f91)

# å•é¡Œæèµ·

å‚è€ƒã®ã‚³ãƒ¼ãƒ‰

```rb
# Read Only APIã®å‡¦ç†ã®ä¸­ã§

class ParentAPI
  def call
    parent = Parent.find(id)
    children = [
      Child.build(name: 'å­1', parent_id: parent.id),
      Child.build(name: 'å­2', parent_id: parent.id),
    ]
    # ã“ã®æ™‚ç‚¹ã§childrenãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹ï¼ï¼Ÿ
    parent.children = children

    # ã“ã“ã§ã€parentã¨childrenãŒã¾ã¨ã‚ã¦ä¿å­˜ã•ã‚Œã‚‹ã¨æ€ã£ã¦ã„ãŸ
    parent.save!
  end
end
```

ãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ¡ãƒ¼ã‚¸

```rb
class Parent < ApplicationRecord
  has_many :children
end

class Child < ApplicationRecord
  belongs_to :parent
end
```

## ä½•ãŒé©šãï¼Ÿ: save!å‰ã«å­ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹

`parent.children = children` ã§
`parent.save!` å‰ã«å­ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã«æ°—ã¥ã„ãŸã€‚

æœ¬æ¥ã§ã‚ã‚Œã°ã€`parent.save!` ã§ã¾ã¨ã‚ã¦ä¿å­˜ã•ã‚Œã‚‹ã¨æ€ã£ã¦ã„ãŸã€‚
æ—¢ã« id ãŒæŒ¯ã‚‰ã‚Œã¦ã„ã‚‹ & new_record? ãŒ false ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã€‚

â€»ã¡ãªã¿ã«ã€`.build` ã‚’ `.new` ã«ã—ã¦ã‚‚åŒã˜ã ã£ãŸ

```bash
From: /xxx/aaa/parent_api.rb:36 ParentAPI#call:

    31:     children = [
    32:       Child.build(name: 'å­1', parent_id: parent.id),
    33:       Child.build(name: 'å­2', parent_id: parent.id),
    34:     ]
    35:     # ã“ã®æ™‚ç‚¹ã§childrenãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹ï¼ï¼Ÿ
 => 36:     parent.children = children
    37:     binding.pry
> parent.children
=> [#<Child
  id: 1,
  body: "å­1",
  parent_id: 1,
  created_at: "2024-11-24 14:04:39.204987000 +0900",
  updated_at: "2024-11-24 14:04:39.204987000 +0900">,
 #<Child
  id: 2, # parentã‚’æŒ‡å®šã—ãŸæ–¹ã ã‘ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒä½œæˆã•ã‚Œã‚‹
  body: "å­2",
  parent_id: 1,
  created_at: "2024-11-24 14:04:39.204987000 +0900",
  updated_at: "2024-11-24 14:04:39.204987000 +0900">]
> parent.children[0].new_record?
=> false
> parent.children[1].new_record?
=> false
```

## è§£æ±ºç­–: parent_id ã‚’æ‰‹å‹•ã§æŒ‡å®šã—ãªã„

Child.build ã®æ™‚ã«ã€parent_id ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€å­ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒä¿å­˜ã•ã‚Œã¦ã„ãŸã€‚
æŒ‡å®šã—ãªã„ or parent:ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æŒ‡å®šã™ã‚‹ã¨ã€ä¿å­˜ã•ã‚Œãªã„ã“ã¨ãŒã‚ã‹ã£ãŸã€‚

```diff rb
# Read Only APIã®å‡¦ç†ã®ä¸­ã§

class ParentAPI
  def call
    parent = Parent.find(id)
    children = [
-     Child.build(name: 'å­1', parent_id: parent.id),
-     Child.build(name: 'å­2', parent_id: parent.id),
+     Child.build(name: 'å­1'),
+     Child.build(name: 'å­2'),
      # or
      # Child.build(name: 'å­1', parent:),
      # Child.build(name: 'å­2', parent:),
    ]
    # ã“ã®æ™‚ç‚¹ã§ã¯ä¿å­˜ã•ã‚Œãªã„
    parent.children = children

    # ã“ã“ã§ã€parentã¨childrenãŒã¾ã¨ã‚ã¦ä¿å­˜ã•ã‚Œã‚‹
    parent.save!
  end
end
```

```bash
From: /xxx/aaa/parent_api.rb:36 ParentAPI#call:

    31:     children = [
    32:       Child.build(name: 'å­1'),
    33:       Child.build(name: 'å­2'),
    34:     ]
    35:     # ã“ã®æ™‚ç‚¹ã§childrenãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹ï¼ï¼Ÿ
 => 36:     parent.children = children
    37:     binding.pry
> parent.children
=> [#<Child
  id: nil,
  body: "å­1",
  parent_id: 1,
  created_at: nil,
  updated_at: nil>,
 #<Child
  id: nil,
  body: "å­2",
  parent_id: 1,
  created_at: nil,
  updated_at: nil>]
> parent.children[0].new_record?
=> false
> parent.children[1].new_record?
=> false
```

## ãªãœ parent_id ã‚’æ‰‹å‹•ã§æŒ‡å®šã™ã‚‹ã¨ autosave ã®æŒ™å‹•ã¨ç•°ãªã‚‹å‹•ãã‚’ã—ãŸã®ã‹

ActiveRecord ã®å†…éƒ¨å®Ÿè£…ã‚’è¿½ã„ãŸã„ãŒã€ä»Šå›ã¯æ–­å¿µã—ãŸã€‚
è©³ã—ã„äººã¯æ•™ãˆã¦æ¬²ã—ã„ã€‚

`parent.children = children` ã®æ™‚ç‚¹ã§ã€parent_id ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã¨ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®é–¢é€£ä»˜ã‘ã®æ•´åˆæ€§ã‚’åˆã‚ã›ã‚‹ãŸã‚ã«ã€ä¿å­˜å‡¦ç†ãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã‚‹ã‚‰ã—ã„ã¨ã„ã†æ‰€ã¾ã§ã—ã‹åˆ†ã‹ã‚‰ãªã‹ã£ãŸã€‚

[ActiveRecord::Associations::CollectionProxy](https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html) å‘¨è¾ºã®å†…éƒ¨å®Ÿè£…ã‚’è¿½ãˆã°åˆ†ã‹ã‚‹ã®ã ã‚ã†ã‹ï¼Ÿ

# TODO: ã‚ã¾ã‚Šé–¢ä¿‚ãŒç„¡ã‹ã£ãŸã®ã§ã€åˆ¥è¨˜äº‹ã«åˆ‡ã‚Šå‡ºã—ãŸã„

## has_many ã® autosave ã®æŒ™å‹•ã«ã¤ã„ã¦ï¼ˆå‘¨è¾ºçŸ¥è­˜ã®ç†è§£ï¼‰

has_many ã®é–¢é€£ã§ autosave ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æœ‰ç„¡ã‚„è¨­å®šå€¤ã«å¿œã˜ã¦ã€æ–°è¦ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ä¿å­˜ã€æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã®æ›´æ–°ã€æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã®å‰Šé™¤ã®æŒ™å‹•ãŒç•°ãªã‚Šã¾ã™ã€‚ã“ã®æŒ™å‹•ã‚’æ­£ç¢ºã«ç†è§£ã™ã‚‹ã“ã¨ã§ã€äºˆæœŸã›ã¬å‹•ä½œã‚’é˜²ãã“ã¨ãŒã§ãã‚‹ã€‚

`parent.save!`ã§ã¾ã¨ã‚ã¦ä¿å­˜ã•ã‚Œã¦ã„ãŸã®ã¯ã€ã“ã®è¨­å®šã®ãŠã‹ã’

```rb
class Parent < ApplicationRecord
  has_many :children, autosave: true # ã¾ãŸã¯ false
end
```

| autosave è¨­å®š | æ–°ã—ã„é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰ | æ—¢å­˜ã®é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰ã®æ›´æ–° | æ—¢å­˜ã®é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰ã®å‰Šé™¤ |
| ------------- | ------------------ | ------------------------ | ------------------------ |
| è¨­å®šãªã—      | â­•ï¸                | âŒ                       | âŒ                       |
| true          | â­•ï¸                | â­•ï¸                      | â­•ï¸                      |
| false         | âŒ                 | âŒ                       | âŒ                       |

â­•ï¸: ä¿å­˜ã•ã‚Œã‚‹
âŒ: ä¿å­˜ã•ã‚Œãªã„

- **autosave: è¨­å®šãªã—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šï¼‰**
  - æ–°ã—ã„é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰: ä¿å­˜ã•ã‚Œã¾ã™ã€‚
  - æ—¢å­˜ã®é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰ã®æ›´æ–°: ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚
  - æ—¢å­˜ã®é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰ã®å‰Šé™¤: ä¿å­˜ã•ã‚Œã¾ã›ã‚“ï¼ˆå‰Šé™¤ã®æ“ä½œã‚‚é©ç”¨ã•ã‚Œã¾ã›ã‚“ï¼‰ã€‚
- **autosave: true**
  - æ–°ã—ã„é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰: ä¿å­˜ã•ã‚Œã¾ã™ã€‚
  - æ—¢å­˜ã®é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰ã®æ›´æ–°: ä¿å­˜ã•ã‚Œã¾ã™ã€‚
  - æ—¢å­˜ã®é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰ã®å‰Šé™¤: ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆå‰Šé™¤ã®æ“ä½œã‚‚é©ç”¨ã•ã‚Œã¾ã™ï¼‰ã€‚
- **autosave: false**
  - æ–°ã—ã„é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰: ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚
  - æ—¢å­˜ã®é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰ã®æ›´æ–°: ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚
  - æ—¢å­˜ã®é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰ã®å‰Šé™¤: ä¿å­˜ã•ã‚Œã¾ã›ã‚“ï¼ˆå‰Šé™¤ã®æ“ä½œã‚‚é©ç”¨ã•ã‚Œã¾ã›ã‚“ï¼‰ã€‚

https://api.rubyonrails.org/classes/ActiveRecord/AutosaveAssociation.html
https://mogulla3.tech/articles/2021-02-07-01/

### è„±ç·š: autosave è¨­å®šãªã—ã¯æ—¢å­˜ã®é–¢é€£ã‚³ãƒ¼ãƒ‰ã®æ›´æ–°ã•ã‚Œãªã„ã£ã¦æœ¬å½“ï¼ï¼Ÿ

ç­†è€…ãŒã€Œå˜˜ã ï¼ãã‚“ãªã®ä¿¡ã˜ãªã„ãï¼ã€ã¨å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ç–‘ã„ã‚’æŒã£ãŸã®ã§ã€å®Ÿéš›ã«è©¦ã—ã¦ã¿ãŸã€‚
å¤§äººã—ãæ•—åŒ—ã—ãŸã€‚

```rb
# Read Only APIã®å‡¦ç†ã®ä¸­ã§

class ParentAPI
  def call
    parent = Parent.find(id)

    # ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã™ã‚‹
    child1 = Child.create(name: 'å­1', parent:)
    child2 = Child.create(name: 'å­2', parent:)

    # ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¸Šã§ã¯ã€nameãŒæ›´æ–°ã•ã‚Œã‚‹ã®ã‚’ç¢ºèª
    # ex: child1.name = "æ›´æ–°ã•ã‚ŒãŸå­1"
    parent.children.each do |child|
      child.name = "æ›´æ–°ã•ã‚ŒãŸ#{child.name}"
    end

    # childã®nameã¯æ›´æ–°ã•ã‚Œã¦ã„ãªã„ï¼ï¼
    # ex: child1.name = "å­1"
    parent.save!
  end
end
```
